<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SSE Chat Chunk Demo</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
      }
      #log {
        border: 1px solid #ccc;
        padding: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
        font-family: monospace;
        background: #f9f9f9;
      }
      .chunk {
        padding: 2px 0;
      }
    </style>
  </head>
  <body>
    <h1>SSE Chat Chunk Demo</h1>

    <p>
      This page connects to <code>/stream</code> and receives chunks generated
      on the server every 0.5s. On reconnection, all chunks are replayed from
      the beginning.
    </p>

    <p>
      <button id="reconnect">Reconnect</button>
      <button id="disconnect">Disconnect</button>
    </p>

    <div>
      Status: <span id="status">Disconnected</span> | Last index:
      <span id="lastIndex">-1</span>
    </div>

    <div id="log"></div>

    <script>
      let eventSource = null;
      let lastIndex = -1;
      let autoReconnect = true;

      const lastIndexSpan = document.getElementById("lastIndex");
      const statusSpan = document.getElementById("status");
      const logDiv = document.getElementById("log");

      function appendChunk(index, chunk) {
        const div = document.createElement("div");
        div.className = "chunk";
        div.textContent = `${index}: ${chunk}`;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function connect() {
        if (eventSource) {
          eventSource.close();
        }

        console.log("Connecting to stream...");
        statusSpan.textContent = "Connecting...";
        eventSource = new EventSource("/stream");

        eventSource.onopen = () => {
          console.log("Connected");
          statusSpan.textContent = "Connected";
        };

        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          lastIndex = data.index;
          lastIndexSpan.textContent = String(lastIndex);
          appendChunk(data.index, data.chunk);
        };

        eventSource.onerror = (err) => {
          console.log("SSE error, closing connection", err);
          statusSpan.textContent = "Error";
          eventSource.close();
          // auto-retry after 1 second if autoReconnect is enabled
          if (autoReconnect) {
            setTimeout(() => connect(), 1000);
          }
        };
      }

      function disconnect() {
        autoReconnect = false;
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }
        statusSpan.textContent = "Disconnected";
        console.log("Disconnected");
      }

      // Initial connect
      connect();

      document.getElementById("reconnect").addEventListener("click", () => {
        // Clear UI and reconnect
        logDiv.innerHTML = "";
        lastIndex = -1;
        lastIndexSpan.textContent = "-1";
        autoReconnect = true;
        connect();
      });

      document.getElementById("disconnect").addEventListener("click", () => {
        disconnect();
      });
    </script>
  </body>
</html>
